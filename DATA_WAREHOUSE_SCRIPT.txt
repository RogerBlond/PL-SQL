--------------------------------------------========WYMIARY===========------------------------------------------
CREATE TABLE CW_DIM
AS
SELECT distinct CWICZENIE
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
;

CREATE TABLE TYP_ODD_DIM
AS
SELECT distinct ENGAGEMENT_TYPE AS TYP_ODDZIALYWANIA, TYPE_ATTRITION AS RODZAJ_ODDZIALYWANIA, TYPE_WEAPON_FIRED AS RODZAJ_UZYTEJ_BRONI
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
;

CREATE TABLE SIDE_DIM
AS
SELECT distinct KILLER_OWNING_SIDE AS KOLOR
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
;

CREATE TABLE LEVEL_DIM
AS
SELECT distinct KILLER_LEVEL AS SZCZEBEL, KILLER_LEVEL_HQ AS PRZELOZONY
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
;

CREATE TABLE K_SYM_DIM
AS
SELECT distinct KILLER_SYMBOL AS SYMBOL
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
;

CREATE TABLE SYS_DIM
AS
SELECT distinct TYPE_SYSTEM AS TYP_SYSTEMU, GRUPA, DAMAGED_SYSTEM AS RODZAJ_USZKODZONEGO_SYS
FROM "WAREHOUSE".MV_ENG_STRATY
;

--CZAS--
CREATE TABLE CZAS_BEZWZGL_DIM
AS
WITH przedzial_brama
    as
    (
    
    select
    trunc(min_time,'HH24') -1/24 + level/24 data_od,
    trunc(min_time,'HH24') + level/24 data_do,
    (trunc(min_time,'HH24') -1/24 + level/24)  || ' - ' ||
    (trunc(min_time,'HH24') + level/24) przedzial
    from
    (
    select min(time) min_time,max(time) max_time
    from
    "WAREHOUSE"."MV_BRAMA21_ALL_DDS_GR"
    )
    connect by level <= ( trunc(max_time,'HH24')+1/24 - trunc(min_time,'HH24')) * 24
    ),
    
    przedzial_bobr
    as
    (
    select
    trunc(min_time,'HH24') -1/24 + level/24 data_od,
    trunc(min_time,'HH24') + level/24 data_do,
    (trunc(min_time,'HH24') -1/24 + level/24)  || ' - ' ||
    (trunc(min_time,'HH24') + level/24) przedzial
    from
    (
    select min(time) min_time,max(time) max_time
    from
    "WAREHOUSE".dw_aar_engagement_all
    )
    connect by level <= ( trunc(max_time,'HH24')+1/24 - trunc(min_time,'HH24')) * 24
    )
    
SELECT distinct data_od AS CZAS_START, data_do AS CZAS_KONCOWY
FROM przedzial_brama
UNION
SELECT distinct data_od AS CZAS_START, data_do AS CZAS_KONCOWY
FROM przedzial_bobr
;

CREATE TABLE CZAS_WZGL_DIM
AS
SELECT distinct DOBA, ZMIANA
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
;

----------------------------------------------------------------------------------------------------------------
TRUNCATE TABLE CW_DIM;
TRUNCATE TABLE CZAS_BEZWZGL_DIM;
TRUNCATE TABLE CZAS_WZGL_DIM;
TRUNCATE TABLE K_SYM_DIM;
TRUNCATE TABLE LEVEL_DIM;
TRUNCATE TABLE SIDE_DIM;
TRUNCATE TABLE TYP_ODD_DIM;
TRUNCATE TABLE SYS_DIM;
----------------------------------------------------------------------------------------------------------------
ALTER TABLE CW_DIM
ADD (CW_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
     CONSTRAINT CW_ID_PK PRIMARY KEY(CW_ID));

ALTER TABLE TYP_ODD_DIM
ADD (TO_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
     CONSTRAINT TO_ID_PK PRIMARY KEY(TO_ID));

ALTER TABLE SIDE_DIM
ADD (S_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
     CONSTRAINT S_ID_PK PRIMARY KEY(S_ID));

ALTER TABLE LEVEL_DIM
ADD (L_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
     CONSTRAINT L_ID_PK PRIMARY KEY(L_ID));

ALTER TABLE K_SYM_DIM
ADD (K_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
     CONSTRAINT K_ID_PK PRIMARY KEY(K_ID)); 

ALTER TABLE SYS_DIM
ADD (SYS_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
     CONSTRAINT SYS_ID_PK PRIMARY KEY(SYS_ID)); 

ALTER TABLE CZAS_BEZWZGL_DIM
ADD (CB_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
     CONSTRAINT CB_ID_PK PRIMARY KEY(CB_ID)); 

ALTER TABLE CZAS_WZGL_DIM
ADD (C_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
     CONSTRAINT C_ID_PK PRIMARY KEY(C_ID),
     GODZINA NUMBER DEFAULT NULL); 
----------------------------------------------------FAKTY-------------------------------------------------------
CREATE TABLE ZUZ_AMU_FACTS
(
F_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
CW_ID NUMBER,
CONSTRAINT CW_ID_FK FOREIGN KEY(CW_ID) REFERENCES CW_DIM(CW_ID),
C_ID NUMBER,
CONSTRAINT C_ID_FK FOREIGN KEY(C_ID) REFERENCES CZAS_WZGL_DIM(C_ID),
CB_ID NUMBER,
CONSTRAINT CB_ID_FK FOREIGN KEY(CB_ID) REFERENCES CZAS_BEZWZGL_DIM(CB_ID),
TO_ID NUMBER,
CONSTRAINT TO_ID_FK FOREIGN KEY(TO_ID) REFERENCES TYP_ODD_DIM(TO_ID),
S_ID NUMBER,
CONSTRAINT S_ID_FK FOREIGN KEY(S_ID) REFERENCES SIDE_DIM(S_ID),
L_ID NUMBER,
CONSTRAINT L_ID_FK FOREIGN KEY(L_ID) REFERENCES LEVEL_DIM(L_ID),
K_ID NUMBER,
CONSTRAINT K_ID_FK FOREIGN KEY(K_ID) REFERENCES K_SYM_DIM(K_ID),
SUM_NWF NUMBER
);

CREATE TABLE STRATY_FACTS
(
F_ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
CW_ID NUMBER,
CONSTRAINT CW_ID_FK_STRATY FOREIGN KEY(CW_ID) REFERENCES CW_DIM(CW_ID),
C_ID NUMBER,
CONSTRAINT C_ID_FK_STRATY FOREIGN KEY(C_ID) REFERENCES CZAS_WZGL_DIM(C_ID),
CB_ID NUMBER,
CONSTRAINT CB_ID_FK_STRATY FOREIGN KEY(CB_ID) REFERENCES CZAS_BEZWZGL_DIM(CB_ID),
TO_ID NUMBER,
CONSTRAINT TO_ID_FK_STRATY FOREIGN KEY(TO_ID) REFERENCES TYP_ODD_DIM(TO_ID),
KK_ID NUMBER,
CONSTRAINT KK_ID_FK_STRATY FOREIGN KEY(KK_ID) REFERENCES K_SYM_DIM(K_ID),
VK_ID NUMBER,
CONSTRAINT VK_ID_FK_STRATY FOREIGN KEY(VK_ID) REFERENCES K_SYM_DIM(K_ID),
KL_ID NUMBER,
CONSTRAINT KL_ID_FK_STRATY FOREIGN KEY(KL_ID) REFERENCES LEVEL_DIM(L_ID),
VL_ID NUMBER,
CONSTRAINT VL_ID_FK_STRATY FOREIGN KEY(VL_ID) REFERENCES LEVEL_DIM(L_ID),
KS_ID NUMBER,
CONSTRAINT KS_ID_FK_STRATY FOREIGN KEY(KS_ID) REFERENCES SIDE_DIM(S_ID),
VS_ID NUMBER,
CONSTRAINT VS_ID_FK_STRATY FOREIGN KEY(VS_ID) REFERENCES SIDE_DIM(S_ID),
SYS_ID NUMBER,
CONSTRAINT SYS_ID_FK_STRATY FOREIGN KEY (SYS_ID) REFERENCES SYS_DIM(SYS_ID),
DMGD NUMBER,
KILLD NUMBER
);
----------------------------------------------------INSERTY-WYMIARY-----------------------------------------------------
INSERT INTO CW_DIM(CWICZENIE)
(
SELECT distinct CWICZENIE
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
);

INSERT INTO TYP_ODD_DIM(TYP_ODDZIALYWANIA, RODZAJ_ODDZIALYWANIA,RODZAJ_UZYTEJ_BRONI)
(
SELECT distinct ENGAGEMENT_TYPE AS TYP_ODDZIALYWANIA, TYPE_ATTRITION AS RODZAJ_ODDZIALYWANIA, TYPE_WEAPON_FIRED AS RODZAJ_UZYTEJ_BRONI
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
);

INSERT INTO SIDE_DIM(KOLOR)
(
SELECT distinct KILLER_OWNING_SIDE AS KOLOR
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
UNION
SELECT distinct VICTIM_OWNING_SIDE AS KOLOR
FROM "WAREHOUSE".MV_ENG_STRATY
);

INSERT INTO LEVEL_DIM(SZCZEBEL, PRZELOZONY)
(
select distinct KILLER_LEVEL ,KILLER_LEVEL_HQ from warehouse.mv_eng_straty 
union
select distinct victim_level  ,victim_level_hq from warehouse.mv_eng_straty
UNION
select distinct KILLER_LEVEL  ,KILLER_LEVEL_HQ from WAREHOUSE.mv_eng_zuzycie_amu
);

/*INSERT INTO K_SYM_DIM(SYMBOL)
(
SELECT distinct KILLER_SYMBOL AS SYMBOL
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
);
*/
--v2 dane pobieramy do wymiaru na podstawie zrodla najwiekszej tabeli faktÃ³w w hurtowni
INSERT INTO K_SYM_DIM(SYMBOL)
(
select distinct killer_symbol AS SYMBOL from warehouse.mv_eng_straty
union 
select distinct victim_symbol AS SYMBOL from warehouse.mv_eng_straty
);



INSERT INTO SYS_DIM(TYP_SYSTEMU, GRUPA, RODZAJ_USZKODZONEGO_SYS)
(
SELECT distinct TYPE_SYSTEM AS TYP_SYSTEMU, GRUPA, DAMAGED_SYSTEM AS RODZAJ_USZKODZONEGO_SYS
FROM "WAREHOUSE".MV_ENG_STRATY
);

INSERT INTO CZAS_BEZWZGL_DIM(CZAS_START, CZAS_KONCOWY)
WITH przedzial_brama
    as
    (
    
    select
    trunc(min_time,'HH24') -1/24 + level/24 data_od,
    trunc(min_time,'HH24') + level/24 data_do,
    (trunc(min_time,'HH24') -1/24 + level/24)  || ' - ' ||
    (trunc(min_time,'HH24') + level/24) przedzial
    from
    (
    select min(time) min_time,max(time) max_time
    from
    "WAREHOUSE"."MV_BRAMA21_ALL_DDS_GR"
    )
    connect by level <= ( trunc(max_time,'HH24')+1/24 - trunc(min_time,'HH24')) * 24
    ),
    
    przedzial_bobr
    as
    (
    select
    trunc(min_time,'HH24') -1/24 + level/24 data_od,
    trunc(min_time,'HH24') + level/24 data_do,
    (trunc(min_time,'HH24') -1/24 + level/24)  || ' - ' ||
    (trunc(min_time,'HH24') + level/24) przedzial
    from
    (
    select min(time) min_time,max(time) max_time
    from
    "WAREHOUSE".dw_aar_engagement_all
    )
    connect by level <= ( trunc(max_time,'HH24')+1/24 - trunc(min_time,'HH24')) * 24
    )
SELECT distinct data_od AS CZAS_START, data_do AS CZAS_KONCOWY
FROM przedzial_brama
UNION
SELECT distinct data_od AS CZAS_START, data_do AS CZAS_KONCOWY
FROM przedzial_bobr
;



INSERT INTO CZAS_WZGL_DIM(DOBA, ZMIANA, GODZINA)
SELECT distinct DOBA, ZMIANA,GODZINA
FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
order by DOBA, ZMIANA,GODZINA
;


-----------------------------------------------INSERT-FACTS------------------------------------------------------------
--porceduralnie: temp table, ladowanie z wymiarow to co jest w MV, insert selecta z joinami, drop temp table
--TEMP TABLE:
--temp table do zuz_amu_facts
CREATE TABLE TEMP_ETL_ZUZ_FACTS AS (
SELECT CWICZENIE, DOBA, ZMIANA, GODZINA, TO_DATE(SUBSTR(PRZEDZIAL,1,19),'DD/MM/YYYY HH24:MI:SS') CZAS_START, TO_DATE(SUBSTR(PRZEDZIAL,23,41),'DD/MM/YYYY HH24:MI:SS') CZAS_KONCOWY, ENGAGEMENT_TYPE AS TYP_ODDZIALYWANIA, TYPE_ATTRITION AS RODZAJ_ODDZIALYWANIA,KILLER_OWNING_SIDE AS KOLOR,KILLER_SYMBOL AS SYMBOL, KILLER_LEVEL AS SZCZEBEL, KILLER_LEVEL_HQ AS PRZELOZONY,TYPE_WEAPON_FIRED AS RODZAJ_UZYTEJ_BRONI,SUM_NUMBER_WEAPONS_FIRED as MIARA

FROM "WAREHOUSE".MV_ENG_ZUZYCIE_AMU
);



--INSERT Z TEMP TABLE DO ZUZ_AMU_FACTS
INSERT INTO ZUZ_AMU_FACTS (
CW_ID,
C_ID,
CB_ID,
TO_ID,
S_ID,
L_ID,
K_ID,
SUM_NWF)
(
    SELECT 
    cw.CW_ID,
    czw.C_ID,
    czb.CB_ID,
    t.TO_ID,
    s.S_ID,
    l.L_ID,
    ks.K_ID,
    mv.MIARA
    
    FROM TEMP_ETL_ZUZ_FACTS mv
    
    LEFT JOIN CW_DIM cw ON NVL(cw.CWICZENIE,' ') =NVL(mv.CWICZENIE,' ')
    LEFT JOIN CZAS_BEZWZGL_DIM czb ON NVL(TO_CHAR(czb.CZAS_START,'DD-MON-RR  HH24:MI:SS'),'DD-MON-RR') =NVL(TO_CHAR(mv.CZAS_START,'DD-MON-RR  HH24:MI:SS'),'DD-MON-RR') and NVL(TO_CHAR(czb.CZAS_KONCOWY,'DD-MON-RR  HH24:MI:SS'),'DD-MON-RR')=NVL(TO_CHAR(mv.CZAS_KONCOWY,'DD-MON-RR  HH24:MI:SS'),'DD-MON-RR')
    LEFT JOIN CZAS_WZGL_DIM czw ON NVL(czw.GODZINA,0)=NVL(mv.GODZINA,0) and NVL(czw.DOBA,' ')=NVL(mv.DOBA,' ') and NVL(czw.ZMIANA,' ')=NVL(mv.ZMIANA,' ')
    LEFT JOIN K_SYM_DIM ks ON NVL(ks.SYMBOL,' ')=NVL(mv.SYMBOL,' ')
    LEFT JOIN LEVEL_DIM l ON NVL(l.SZCZEBEL,' ')=NVL(mv.SZCZEBEL,' ') and NVL(l.PRZELOZONY,' ')=NVL(mv.PRZELOZONY,' ')
    LEFT JOIN SIDE_DIM s ON NVL(s.KOLOR,' ')=NVL(mv.KOLOR,' ')
    LEFT JOIN TYP_ODD_DIM t ON NVL(t.RODZAJ_UZYTEJ_BRONI,' ')=NVL(mv.RODZAJ_UZYTEJ_BRONI,' ') and NVL(t.TYP_ODDZIALYWANIA,' ')=NVL(mv.TYP_ODDZIALYWANIA,' ') and NVL(t.RODZAJ_ODDZIALYWANIA,' ')=NVL(mv.RODZAJ_ODDZIALYWANIA,' ')
);

--INSERT Z TEMP TABLE DO STRATY_FACTS (bez kolumny wspolczynnika)
CREATE TABLE TEMP_ETL_STRATY_FACTS AS (
SELECT CWICZENIE, DOBA, ZMIANA, GODZINA, TO_DATE(SUBSTR(PRZEDZIAL,1,19),'DD/MM/YYYY HH24:MI:SS') CZAS_START, TO_DATE(SUBSTR(PRZEDZIAL,23,41),'DD/MM/YYYY HH24:MI:SS') CZAS_KONCOWY,
ENGAGEMENT_TYPE AS TYP_ODDZIALYWANIA_KILLER,
TYPE_ATTRITION AS RODZAJ_ODDZIALYWANIA_KILLER,
KILLER_OWNING_SIDE AS KOLOR_KILLER,
KILLER_SYMBOL AS SYMBOL_KILLER, 
KILLER_LEVEL AS SZCZEBEL_KILLER, 
KILLER_LEVEL_HQ AS PRZELOZONY_KILLER,
TYPE_WEAPON_FIRED AS RODZAJ_UZYTEJ_BRONI_KILLER,

VICTIM_OWNING_SIDE  AS KOLOR_VICTIM,
VICTIM_SYMBOL  AS SYMBOL_VICTIM,
VICTIM_LEVEL AS SZCZEBEL_VICTIM,
VICTIM_LEVEL_HQ AS PRZELOZONY_VICTIM,
TYPE_SYSTEM AS TYP_SYSTEMU_VICTIM,
DAMAGED_SYSTEM AS RODZAJ_USZKODZONEGO_SYS_VICTIM,
GRUPA AS GRUPA_VICTIM,
SUM_NUMBER_DAMAGED AS SUMA_USZKODZONYCH_RANNYCH,
SUM_NUMBER_KILLED AS SUMA_ZNISZCZONYCH_ZABITYCH

FROM "WAREHOUSE".MV_ENG_STRATY
);

INSERT INTO STRATY_FACTS (
CW_ID,
C_ID,
CB_ID,
TO_ID,
KK_ID,
VK_ID,
KL_ID,
VL_ID,
KS_ID,
VS_ID,
SYS_ID,
DMGD,
KILLD)
(
    SELECT 
    cw.CW_ID,
    czw.C_ID,
    czb.CB_ID,
    t.TO_ID,
    
    ks.K_ID,
    ks2.K_ID,
    l.L_ID,
    l2.L_ID,
    s.S_ID,
    s2.S_ID,
    
    
    sy.SYS_ID,
    
    mv.SUMA_USZKODZONYCH_RANNYCH,
    mv.SUMA_ZNISZCZONYCH_ZABITYCH
    
    FROM TEMP_ETL_STRATY_FACTS mv
    
    LEFT JOIN CW_DIM cw ON NVL(cw.CWICZENIE,' ') =NVL(mv.CWICZENIE,' ')
    LEFT JOIN CZAS_BEZWZGL_DIM czb ON NVL(TO_CHAR(czb.CZAS_START,'DD-MON-RR  HH24:MI:SS'),'DD-MON-RR') =NVL(TO_CHAR(mv.CZAS_START,'DD-MON-RR  HH24:MI:SS'),'DD-MON-RR') and NVL(TO_CHAR(czb.CZAS_KONCOWY,'DD-MON-RR  HH24:MI:SS'),'DD-MON-RR')=NVL(TO_CHAR(mv.CZAS_KONCOWY,'DD-MON-RR  HH24:MI:SS'),'DD-MON-RR')
    LEFT JOIN CZAS_WZGL_DIM czw ON NVL(czw.GODZINA,0)=NVL(mv.GODZINA,0) and NVL(czw.DOBA,' ')=NVL(mv.DOBA,' ') and NVL(czw.ZMIANA,' ')=NVL(mv.ZMIANA,' ')
    LEFT JOIN K_SYM_DIM ks ON NVL(ks.SYMBOL,' ')=NVL(mv.SYMBOL_KILLER,' ')
    LEFT JOIN K_SYM_DIM ks2 ON NVL(ks2.SYMBOL,' ')=NVL(mv.SYMBOL_VICTIM,' ')

    LEFT JOIN LEVEL_DIM l ON NVL(l.SZCZEBEL,' ')=NVL(mv.SZCZEBEL_KILLER,' ') and NVL(l.PRZELOZONY,' ')=NVL(mv.PRZELOZONY_KILLER,' ')
    LEFT JOIN LEVEL_DIM l2 ON NVL(l2.SZCZEBEL,' ')=NVL(mv.SZCZEBEL_VICTIM,' ') and NVL(l2.PRZELOZONY,' ')=NVL(mv.PRZELOZONY_VICTIM,' ')
    

    LEFT JOIN SIDE_DIM s ON NVL(s.KOLOR,' ')=NVL(mv.KOLOR_KILLER,' ')
    LEFT JOIN SIDE_DIM s2 ON NVL(s2.KOLOR,' ')=NVL(mv.KOLOR_VICTIM,' ')

    LEFT JOIN TYP_ODD_DIM t ON NVL(t.RODZAJ_UZYTEJ_BRONI,' ')=NVL(mv.RODZAJ_UZYTEJ_BRONI_KILLER,' ') and NVL(t.TYP_ODDZIALYWANIA,' ')=NVL(mv.TYP_ODDZIALYWANIA_KILLER,' ') and NVL(t.RODZAJ_ODDZIALYWANIA,' ')=NVL(mv.RODZAJ_ODDZIALYWANIA_KILLER,' ')
    
    LEFT JOIN SYS_DIM sy ON NVL(sy.TYP_SYSTEMU,' ')=NVL(mv.TYP_SYSTEMU_VICTIM,' ') and NVL(sy.GRUPA,' ')=NVL(mv.GRUPA_VICTIM,' ') and NVL(sy.RODZAJ_USZKODZONEGO_SYS,' ')=NVL(mv.RODZAJ_USZKODZONEGO_SYS_VICTIM,' ')

);
